<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>éŸ³è¨ŠéŒ„è£½èˆ‡è½‰æ›å·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@latest/dist/ffmpeg.min.js"></script>
</head>
<body class="bg-gray-100 p-6 min-h-screen flex flex-col items-center justify-start gap-6">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-xl">
    <h1 class="text-2xl font-bold mb-4">ğŸ™ï¸ éŒ„éŸ³å·¥å…·ï¼ˆMP3 / WebMï¼‰</h1>

    <div class="mb-4 flex flex-col gap-2">
      <label class="text-gray-700 font-medium">éŒ„éŸ³æ ¼å¼ï¼š</label>
      <select id="formatSelect" class="border rounded px-3 py-2">
        <option value="mp3">MP3</option>
        <option value="webm">WebM</option>
      </select>
    </div>

    <div class="flex justify-center gap-4 mb-6">
      <button id="startBtn" class="bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 disabled:bg-blue-300 transition">éŒ„éŸ³</button>
      <button id="stopBtn" class="bg-red-500 text-white px-4 py-2 rounded-xl hover:bg-red-600 disabled:bg-red-300 transition" disabled>åœæ­¢</button>
    </div>

    <div id="recordingsList" class="space-y-4 text-left"></div>
  </div>

  <!-- WebMè½‰MP3 -->
  <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-xl mt-4">
    <h2 class="text-xl font-bold mb-2">ğŸ” ä¸Šå‚³ WebM è½‰ MP3</h2>
    <input type="file" id="uploadInput" accept=".webm" class="mb-4 block">
    <button id="convertBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-green-300" disabled>è½‰æ›ç‚º MP3</button>
    <div id="conversionResult" class="mt-4"></div>
  </div>

  <script>
    const allLinks = [
      { text: "æŠ½ç±¤å°ç¨‹å¼", url: "æŠ½ç±¤.html", icon: "bi-dice-5" },
      { text: "è¨ˆæ•¸å™¨", url: "è¨ˆæ•¸å™¨.html", icon: "bi-journal-code" },
      { text: "éŒ„éŸ³(æ¸¬è©¦)", url: "éŒ„éŸ³.html", icon: "bi-journal-code" },
      { text: "å·¥å…·é›†åˆ", url: "https://example.com/tools", icon: "bi-tools" },
      { text: "éƒ¨è½æ ¼", url: "https://example.com/blog", icon: "bi-chat-dots" },
      { text: "API ç¯„ä¾‹", url: "https://example.com/api", icon: "bi-braces" },
      { text: "è¨­è¨ˆå·¥å…·", url: "https://example.com/design-tools", icon: "bi-brush" },
      { text: "é–‹ç™¼å·¥å…·", url: "https://example.com/dev-tools", icon: "bi-code-slash" },
      { text: "æ¸¬è©¦å·¥å…·", url: "https://example.com/test-tools", icon: "bi-bug" },
      { text: "è³‡æ–™åˆ†æ", url: "https://example.com/data-analysis", icon: "bi-bar-chart" },
      { text: "å­¸ç¿’è³‡æº", url: "https://example.com/learning-resources", icon: "bi-book" },
      { text: "ç·šä¸Šç·¨è¼¯å™¨", url: "https://example.com/online-editor", icon: "bi-pencil-square" }
    ];

    const itemsPerPage = 5;
    let currentPage = 1;

    function showRecording(blob, format) {
      const url = URL.createObjectURL(blob);
      const filename = `${getTimestamp()}.${format}`;
      const container = document.createElement('div');
      container.className = 'bg-gray-50 p-4 rounded-xl shadow flex flex-col gap-2';
      container.innerHTML = `
        <div class="font-medium text-gray-700">ğŸ“ ${filename}</div>
        <audio controls src="${url}" class="w-full"></audio>
        <a class="text-blue-600 underline text-sm" download="${filename}" href="${url}">â¬‡ï¸ ä¸‹è¼‰</a>
      `;
      recordingsList.prepend(container);
    }

    function mergeBuffers(channelBuffer, recordingLength) {
      const result = new Float32Array(recordingLength);
      let offset = 0;
      for (const chunk of channelBuffer) {
        result.set(chunk, offset);
        offset += chunk.length;
      }
      return result;
    }

    function encodeMP3(samples) {
      const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
      const sampleBlockSize = 1152;
      const int16Samples = floatTo16BitPCM(samples);
      const mp3Data = [];

      for (let i = 0; i < int16Samples.length; i += sampleBlockSize) {
        const chunk = int16Samples.subarray(i, i + sampleBlockSize);
        const mp3buf = mp3Encoder.encodeBuffer(chunk);
        if (mp3buf.length > 0) mp3Data.push(mp3buf);
      }
      const final = mp3Encoder.flush();
      if (final.length > 0) mp3Data.push(final);

      return new Blob(mp3Data, { type: 'audio/mp3' });
    }

    function floatTo16BitPCM(input) {
      const output = new Int16Array(input.length);
      for (let i = 0; i < input.length; i++) {
        const s = Math.max(-1, Math.min(1, input[i]));
        output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      return output;
    }

    // WebMè½‰MP3
    const uploadInput = document.getElementById('uploadInput');
    const convertBtn = document.getElementById('convertBtn');
    const conversionResult = document.getElementById('conversionResult');

    uploadInput.onchange = () => {
      convertBtn.disabled = !uploadInput.files.length;
    };

    convertBtn.onclick = async () => {
      const file = uploadInput.files[0];
      const { createFFmpeg, fetchFile } = window.FFmpeg;
      const FFmpeg = await loadFFmpeg();
      const ffmpegInstance = FFmpeg.createFFmpeg({ log: true });
      await ffmpegInstance.load();
      ffmpegInstance.FS('writeFile', 'input.webm', await fetchFile(file));
      await ffmpegInstance.run('-i', 'input.webm', 'output.mp3');
      const data = ffmpegInstance.FS('readFile', 'output.mp3');
      const mp3Blob = new Blob([data.buffer], { type: 'audio/mp3' });
      const url = URL.createObjectURL(mp3Blob);
      const filename = `${getTimestamp()}_converted.mp3`;
      conversionResult.innerHTML = `
        <p class="text-sm text-gray-600 mb-2">âœ… è½‰æ›æˆåŠŸï¼š${filename}</p>
        <audio controls src="${url}" class="w-full mb-2"></audio>
        <a href="${url}" download="${filename}" class="text-blue-600 underline text-sm">â¬‡ï¸ ä¸‹è¼‰ MP3</a>
      `;
    };
  </script>
</body>
</html>
